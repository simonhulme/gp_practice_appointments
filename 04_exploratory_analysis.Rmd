---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE}
library(tidyverse)
library(timetk)

wakefield_daily <- read_rds("00_data/processed/wakefield_daily_adjusted.rds")
```

# 1: Summary Statistics

```{r}
skimr::skim(wakefield_daily)
```

-   1373 days between 2019-03-01 and 2024-06-28

-   numeric response variable with no missing values

-   4 categorical variables (nominal)

# 2: Exploratory Visualisation

## 2a: Distribution of appointmentsTotal appointments

```{r}
# overall
total_daily_appointments <- 
    wakefield_daily %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        total_appointments = sum(count_of_appointments)
    )

total_daily_appointments %>% 
    ggplot(aes(total_appointments)) +
    geom_histogram(bins = 20, fill = "skyblue", color = "grey30") +
    theme_bw() +
    labs(title = "Distribution of Total Daily Appointments")

total_daily_appointments %>% 
    filter(total_appointments > 0) %>%  
    select(total_appointments) %>% 
    summary()
```

```{r}
gp_daily_appointments <- 
    wakefield_daily %>%
    filter(hcp_type == "GP") %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        total_appointments = sum(count_of_appointments)
    )

gp_daily_appointments %>% 
    ggplot(aes(total_appointments)) +
    geom_histogram(bins = 20, fill = "skyblue", color = "grey30") +
    theme_bw() +
    labs(title = "Distribution of GP Daily Appointments")

gp_daily_appointments %>% 
    filter(total_appointments > 0) %>%  
    select(total_appointments) %>% 
    summary()
```

```{r}
other_staff_daily_appointments <- 
    wakefield_daily %>%
    filter(hcp_type == "Other Practice staff") %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        total_appointments = sum(count_of_appointments)
    )

other_staff_daily_appointments %>% 
    ggplot(aes(total_appointments)) +
    geom_histogram(bins = 20, fill = "skyblue", color = "grey30") +
    theme_bw() +
    labs(title = "Distribution of Other Practice staff Daily Appointments")

other_staff_daily_appointments %>% 
    filter(total_appointments > 0) %>%  
    select(total_appointments) %>% 
    summary()
```

## \*\* FINDINGS

-   approximately normal distributions when zero values for holidays omitted

## 2b: Total Appointments by Feature

```{r}
wakefield_daily %>%
    group_by(hcp_type) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    mutate(hcp_type = fct_reorder(hcp_type, -total_appointments)) %>%
    ggplot(aes(hcp_type, total_appointments)) +
    geom_col(fill = "skyblue", color = "grey30") +
    theme_bw() +
    labs(title = "Total Appointments by HCP Type")
```

-   <div>

    ```{r}
    wakefield_daily %>%
        group_by(appt_mode) %>%
        summarise(total_appointments = sum(count_of_appointments)) %>%
        mutate(appt_mode = fct_reorder(appt_mode, -total_appointments)) %>%
        ggplot(aes(appt_mode, total_appointments)) +
        geom_col(fill = "skyblue", color = "grey30") +
        theme_bw() +
        labs(title = "Total Appointments by Appointment Mode")
    ```

    </div>

```{r}
wakefield_daily %>%
    group_by(appt_status) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    mutate(appt_status = fct_reorder(appt_status, -total_appointments)) %>%
    ggplot(aes(appt_status, total_appointments)) +
    geom_col(fill = "skyblue", color = "grey30") +
    theme_bw() +
    labs(title = "Total Appointments by Appointment Status")
```

```{r}
wakefield_daily %>%
    group_by(time_between_book_and_appt) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    ggplot(aes(time_between_book_and_appt, total_appointments)) +
    geom_col(fill = "skyblue", color = "grey30") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    labs(title = "Total Appointments by Time Between Booking and Appointment Date",
         x = "Time between booking and appointment date")

wakefield_daily %>%
    mutate(
        booking_type = if_else(
            time_between_book_and_appt == "Same Day",
            "Same Day",
            "Advance"
        )
    ) %>%
    group_by(booking_type) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    ggplot(aes(booking_type, total_appointments)) +
    geom_col(fill = "skyblue", color = "grey30") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    labs(title = "Total Appointments by Booking Type",
         x = "Booking Type")
```

## \*\* FINDINGS

-   More appointments booked with Other Practice Staff than with GPs

-   More appointments booked as Face-to-Face than other modes

-   Only a small percentage DNAs but not sure what 'unknown' means

-   Same day appointments are most frequent individual group although overall more appointments booked in advance (all non same day appointments aggregated)

## 2c: Appointments vs. HCP Type by Feature

```{r}
wakefield_daily %>%
    filter(hcp_type == "GP" | hcp_type == "Other Practice staff",
           appt_mode %in% c("Face-to-Face", "Telephone")) %>% 
    group_by(hcp_type, appt_mode) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    mutate(appt_mode = fct_reorder(appt_mode, total_appointments)) %>%
    ggplot(aes(hcp_type, total_appointments, fill = appt_mode)) +
    geom_col(color = "grey30", position = "fill") +
    theme_bw() +
    tidyquant::scale_fill_tq()
```

```{r}
wakefield_daily %>%
    filter(hcp_type == "GP" | hcp_type == "Other Practice staff",
           appt_mode %in% c("Face-to-Face", "Telephone")) %>% 
    group_by(hcp_type, appt_status) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    mutate(appt_status = fct_reorder(appt_status, total_appointments)) %>%
    ggplot(aes(hcp_type, total_appointments, fill = appt_status)) +
    geom_col(color = "grey30", position = "fill") +
    theme_bw() +
    tidyquant::scale_fill_tq()
```

```{r}
wakefield_daily %>%
    filter(hcp_type == "GP" | hcp_type == "Other Practice staff") %>% 
    group_by(hcp_type, time_between_book_and_appt) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    mutate(prop_appointment = proportions(total_appointments)) %>% 
    ggplot(aes(hcp_type, prop_appointment, fill = time_between_book_and_appt)) +
    geom_col(color = "grey30", position = "dodge") +
    theme_bw() +
    tidyquant::scale_fill_tq()

wakefield_daily %>%
    filter(hcp_type == "GP" | hcp_type == "Other Practice staff") %>% 
    group_by(hcp_type, time_between_book_and_appt) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    mutate(hcp_type = fct_rev(hcp_type)) %>% 
    ggplot(aes(time_between_book_and_appt, total_appointments, fill = hcp_type)) +
    geom_col(position = "fill") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    xlab("Time between booking and appointment date") +
    tidyquant::scale_fill_tq()

wakefield_daily %>%
    filter(hcp_type == "GP" |
               hcp_type == "Other Practice staff") %>%
    mutate(booking_type = if_else(time_between_book_and_appt == "Same Day",
                                  "Same Day",
                                  "Advance")) %>%
    group_by(hcp_type, booking_type) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    mutate(hcp_type = hcp_type) %>%
    ggplot(aes(hcp_type, total_appointments, fill = booking_type)) +
    geom_col(position = "fill") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
    xlab("Time between booking and appointment date") +
    tidyquant::scale_fill_tq()
```

```{r}
wakefield_daily %>%
    filter(hcp_type == "GP" | hcp_type == "Other Practice staff") %>%   
    mutate(appt_status = fct_relevel(appt_status, c("Attended", "Unknown", "DNA"))) %>%
    group_by(hcp_type, appt_status, time_between_book_and_appt) %>%
    summarise(total_appointments = sum(count_of_appointments)) %>%
    ggplot(aes(time_between_book_and_appt, total_appointments, fill = appt_status)) +
    geom_col(position = "fill") +
    theme_bw() +
    tidyquant::scale_fill_tq() +
    labs(title = "Very few DNA or Unknown status for same day appointments",
         subtitle = "DNA and Unknown proportion increases as delay increases") +
    facet_wrap(~ hcp_type) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
    
```

## \*\* FINDINGS

-   Proportion of face to face appointments higher for other staff compared to GPs

-   Proportion of DNA/Unknown appointments higher for other staff compared to GPs

-   Proportion of same day appointments higher for GPs compared to other staff

-   Lower DNA rate for same day appointments - rate increases with time between booking and appointment

# 3: Time Series Analysis

Focus on appointments recorded as attended. This provides an overview of the workload.

Look at total appointments plus subgroups - GP vs. Other practice staff, telephone vs. face to face, same day vs advanced booking.Finally look at all combinations.

## 3a: Total Appointments

```{r}
wakefield_filtered_daily <-
    wakefield_daily %>%
    filter(
        hcp_type == "GP" | hcp_type == "Other Practice staff",
        appt_status == "Attended",
        appt_mode %in% c("Face-to-Face", "Telephone"),
        time_between_book_and_appt != "Unknown"
    ) %>%
    mutate(booking_type = if_else(time_between_book_and_appt == "Same Day",
                                  "Same Day",
                                  "Advance"))
```

```{r}
wakefield_filtered_daily %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(count_of_appointments)
    ) %>%
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Total Daily Appointments")
```

```{r}
wakefield_filtered_daily %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "week",
        appointments = sum(count_of_appointments)
    ) %>%
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Total Weekly Appointments")
```

```{r}
wakefield_filtered_daily %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "month",
        appointments = sum(count_of_appointments)
    ) %>%
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Total Monthly Appointments")
```

## \*\* FINDINGS

## 3b: Total Appointments by HCP Type

```{r}
total_appts_by_hcp <-
    wakefield_filtered_daily %>% 
    group_by(hcp_type) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(count_of_appointments))
    

# by day
total_appts_by_hcp %>% 
    group_by(hcp_type) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Daily Appointments by HCP Type")

# by week
total_appts_by_hcp %>% 
    group_by(hcp_type) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "week",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Weekly Appointments by HCP Type")

# by month
total_appts_by_hcp %>% 
    group_by(hcp_type) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "month",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Monthly Appointments by HCP Type")
```

## \*\* FINDINGS

Total appointments increasing since start of 2021 due to a steady increase in appointments with other practice staff. GP appointments peaked in early 2022 and have been decreasing since then.

## 3c: Total Appointments by Booking Type

```{r}
total_appts_by_booking_type <-
    wakefield_filtered_daily %>% 
    group_by(booking_type) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(count_of_appointments))

# by day
total_appts_by_booking_type %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Daily Appointments by Booking Type")

# by week
total_appts_by_booking_type %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "week",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Weekly Appointments by Booking Type")

# by month
total_appts_by_booking_type %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "month",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Monthly Appointments by Booking Type")
```

## \*\* FINDINGS

## 3d: GP Appointments by Mode

```{r}
total_appts_by_appt_mode <-
    wakefield_filtered_daily %>% 
    group_by(appt_mode) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(count_of_appointments))

# by day
total_appts_by_appt_mode %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Daily Appointments by Mode")

# by week
total_appts_by_appt_mode %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "week",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Weekly Appointments by Mode")

# by month
total_appts_by_appt_mode %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "month",
        appointments = sum(appointments)) %>% 
    plot_time_series(.date_var = appointment_date,
                     .value = appointments,
                     .title = "Time Series Plot: Monthly Appointments by Mode")
```

## \*\* FINDINGS

# 4: Autocorrelation analysis

I am most interested in Same Day GP appointments broken down into total, face-to-face. and telephone.

## Total Same Day GP Appointments

```{r}
gp_appt_mode_vs_booking_tbl %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        total_appointments = sum(appointments)
    ) %>% 
    plot_time_series(.date_var = appointment_date, .value = total_appointments)

gp_appt_mode_vs_booking_tbl %>%
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        total_appointments = sum(appointments)
    ) %>%
    plot_acf_diagnostics(.date_var = appointment_date, .value = total_appointments, .lags = 365)
    
```

## Same Day GP Appointments by Appointment Mode

```{r}
gp_appt_mode_vs_booking_tbl %>%
    group_by(appt_mode) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        total_appointments = sum(appointments)
    ) %>% 
    plot_time_series(.date_var = appointment_date, .value = total_appointments)
```

```{r}
gp_appt_mode_vs_booking_tbl %>%
    group_by(appt_mode) %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        total_appointments = sum(appointments)
    ) %>%
    plot_acf_diagnostics(.date_var = appointment_date, .value = total_appointments, .lags = 365)
    
```

### Findings:

# Exploring Seasonality

Focus on GP same day data - Totals vs Phone vs Face to face

```{r}

gp_appt_mode_vs_booking_tbl %>% 
    pivot_wider(names_from = appt_mode, values_from = appointments) %>% 
    mutate(Total = `Face-to-Face` + Telephone) %>% 
    pivot_longer(cols = 3:5, names_to = "appt_mode", values_to = "appointments")
```

```{r}
gp_appt_mode_vs_booking_tbl %>% 
    group_by(appt_mode) %>% 
    plot_seasonal_diagnostics(
        .date_var = appointment_date,
        .value = appointments,
        .feature_set = c("wday.lbl", "month.lbl", "year"),
        .title = ""
    )
```

```{r}



same_day_vs_booked_daily_tbl %>%
    filter(!appt_mode %in% c("Unknown", "Video Conference/Online")) %>%
    plot_seasonal_diagnostics(
        .date_var = appointment_date,
        .value = appointments,
        .feature_set = c("wday.lbl", "month.lbl", "year"),
        .title = "",
        .facet_vars = appt_mode,
        .interactive = FALSE
    ) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

wakefield_working_week_daily %>%
    filter(hcp_type == "GP" | hcp_type == "Other Practice staff",
           appt_mode %in% c("Face-to-Face", "Telephone")) %>% 
    mutate(day = wday(appointment_date, label = TRUE),
           appt_mode = fct_rev(appt_mode)) %>% 
    group_by(day, hcp_type, appt_mode) %>% 
    summarise(total_appointments = sum(count_of_appointments)) %>%
    ungroup() %>% 
    ggplot(aes(day, total_appointments, fill = appt_mode)) +
    geom_col(position = "fill") +
    theme_bw() +
    facet_wrap(~ hcp_type) +
    scale_fill_brewer(type = "qual", palette = 3)

wakefield_working_week_daily %>%
    filter(hcp_type == "GP" | hcp_type == "Other Practice staff",
           appt_mode %in% c("Face-to-Face", "Telephone")) %>% 
    mutate(month = month(appointment_date, label = TRUE),
           appt_mode = fct_rev(appt_mode)) %>% 
    group_by(month, hcp_type, appt_mode) %>% 
    summarise(total_appointments = sum(count_of_appointments)) %>%
    ungroup() %>% 
    ggplot(aes(month, total_appointments, fill = appt_mode)) +
    geom_col(position = "fill") +
    theme_bw() +
    facet_wrap(~ hcp_type) +
    scale_fill_brewer(type = "qual", palette = 3)

same_day_vs_booked_daily_tbl %>%
    filter(!appt_mode %in% c("Unknown", "Video Conference/Online")) %>%
    plot_seasonal_diagnostics(
        .date_var = appointment_date,
        .value = appointments,
        .feature_set = c("wday.lbl", "month.lbl", "year"),
        .title = "",
        .facet_vars = c(booking, hcp_type),
        .interactive = FALSE,
    ) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

same_day_vs_booked_daily_tbl %>% 
    mutate(day = wday(appointment_date, label = TRUE)) %>% 
    group_by(day, hcp_type, booking) %>% 
    summarise(appointments = sum(appointments)) %>%
    ungroup() %>% 
    ggplot(aes(day, appointments, fill = booking)) +
    geom_col(position = "fill") +
    theme_bw() +
    facet_wrap(~ hcp_type) +
    scale_fill_brewer(palette = 3)

same_day_vs_booked_daily_tbl %>% 
    mutate(month = month(appointment_date, label = TRUE),
           appt_mode = fct_rev(appt_mode)) %>% 
    group_by(month, hcp_type, booking) %>%
    summarise(appointments = sum(appointments)) %>%
    ungroup() %>% 
    ggplot(aes(month, appointments, fill = booking)) +
    geom_col(position = "fill") +
    theme_bw() +
    facet_wrap(~ hcp_type) +
    scale_fill_brewer(type = "qual", palette = 3)

```

# 

## Correlation

```{r}
attended_daily_tbl %>% 
    filter(hcp_type != "Total", appointments > 0) %>%
    pivot_wider(names_from = hcp_type, values_from = appointments) %>% 
    ggplot(aes(GP, `Other Practice staff`)) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = 'lm') +
    theme_bw()

attended_daily_tbl %>% 
    filter(hcp_type != "Total", appointments > 0) %>%
    pivot_wider(names_from = hcp_type, values_from = appointments) %>% 
    select(2:3) %>% 
    cor()
```

Total GP appointments attended per day moderately strongly correlated to total Other Practice staff appointments (when zero values omitted)

GP workload is simpler to analyse because in this dataset "Other Practice Staff" is a homogeneous group that may contain HCA, PA, Nurse, Pharmacists etc. and may be better utilised as a feature rather than a response

GP appointments fell around pandemic then increased to a peak between 2022 and 2023. Values appear to be falling since 2023 . Total appointments increasing so reduced total gp workload occurring as workload for other practice staff increasing.

A further question to consider relates to workforce. What are appointment rates per GP? Can workforce data be used to estimate this? Is there any data that describes daily GP sessions?
