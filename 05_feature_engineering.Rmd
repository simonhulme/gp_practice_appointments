---
title: "Feature Engineering"
output: html_notebook
---

```{r message=FALSE}
# Load libraries
library(tidyverse)
library(modeltime)
library(timetk)

# Read in raw Data
appointments <- read_rds("00_data/processed/wakefield_daily_adj.rds")
events       <- read_rds("00_data/processed/wakefield_events.rds")
population   <- read_rds("00_data/processed/wakefield_population_monthly.rds")
```

# Create Time Series

Decisions made:

Time period: Use post pandemic data as model to be used in recovery and post pandemic phase rather then modelling the impact of a pandemic.

GP: Other Practice staff heterogeneous group that is not sub-divided into professions. GP more straightforward to model using the available data

Attended: Reflects actual daily workload

5 day week vs 7 day with zero values for weekend: issues with zeros -TO DESCRIBE REASONS IN DETAIL

```{r}
gp_appts_tbl <-
    appointments %>%
    filter(hcp_type == "GP",
           appt_status == "Attended") %>%
    filter_by_time(.date_var = appointment_date, .start_date = "2021-07-20") %>% 
    summarise_by_time(
        .date_var = appointment_date,
        .by = "day",
        appointments = sum(count_of_appointments)
    ) %>% 
    left_join(events) %>% 
    filter(!weekend) %>% # turn into 5 day business week series
    select(-weekend)
```

### Visualise Time Series

```{r}
gp_appts_tbl %>% 
    plot_time_series(.date_var = appointment_date, .value = appointments)

gp_appts_tbl %>%
    plot_stl_diagnostics(
        .date_var = appointment_date,
        .value = appointments,
        .feature_set = c("season", "trend", "remainder")
    )
```

# Engineer features

Most striking features are weekly seasonality and events - bank holidays + training

Start by modelling these and then adding in longer term seasonal features

```{r}
trend_season_events_tbl <- 
    gp_appts_tbl %>% 
    mutate(wday.lbl  = wday(appointment_date, label = TRUE),
           month.lbl = month(appointment_date, label = TRUE),
           index.num = as.numeric(appointment_date))
```

```{r}
# weekly seasonality and events
trend_season_events_tbl %>%
    plot_time_series_regression(
        .date_var = appointment_date,
        appointments ~ wday.lbl + bank_holiday + training,
        .show_summary = TRUE
    )
```

```{r}
# add monthly seasonality
trend_season_events_tbl %>%
    plot_time_series_regression(
        .date_var = appointment_date,
        appointments ~ wday.lbl + month.lbl + bank_holiday + training,
        .show_summary = TRUE
    )
```

```{r}
# add trend

## linear trend
trend_season_events_tbl %>%
    plot_time_series_regression(
        .date_var = appointment_date,
        appointments ~ index.num + wday.lbl + month.lbl + bank_holiday + training,
        .show_summary = TRUE
    )

## non-linear trend - polynomial
trend_season_events_tbl %>%
    plot_time_series_regression(
        .date_var = appointment_date,
        appointments ~ poly(index.num, 4) + wday.lbl + month.lbl + bank_holiday + training,
        .show_summary = TRUE
    )

## non-linear trend - spline

trend_season_events_tbl %>%
    plot_time_series_regression(
        .date_var = appointment_date,
        appointments ~ splines::ns(index.num, df = 4) + wday.lbl + month.lbl + bank_holiday + training,
        .show_summary = TRUE
    )
```

```{r}
trend_season_event_mdl <-
    lm(appointments ~ splines::ns(index.num, df = 4) + wday.lbl + month.lbl + bank_holiday + training,
       data = trend_season_events_tbl)

summary(trend_season_event_mdl)

## Explore results
trend_season_event_results <- 
    trend_season_events_tbl %>% 
    select(appointment_date, .observed = appointments, everything()) %>% 
    broom::augment(trend_season_event_mdl, data = .) %>% 
    mutate(.resid = .observed - .fitted)

trend_season_event_results %>% 
    select(.resid) %>% 
    ggplot(aes(.resid)) +
    geom_histogram(bins = 30, fill = "skyblue", color = "grey30") +
    theme_bw()

trend_season_event_results %>% 
    select(.observed, .fitted) %>% 
    ggplot(aes(.observed, .fitted)) +
    geom_point(alpha = 0.5) +
    geom_abline() +
    theme_bw()

trend_season_event_results %>% 
    select(.fitted, .resid) %>% 
    ggplot(aes(.fitted, .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0) +
    theme_bw()
```

# Handling Autocorrelation

```{r}
trend_season_event_results %>% 
    select(appointment_date, .resid) %>% 
    plot_acf_diagnostics(.date_var = appointment_date, .value = .resid, .lags = 1:262)

trend_season_events_tbl %>% 
    plot_acf_diagnostics(.date_var = appointment_date, .value = appointments, .lags = 1:262)
```

Add in some lagged terms for model although in real life this would be better captured using a time series model such as ARIMA. Using lagged terms limits ability of model to provide forecasts with small lags and reduces data to model with if large lags. Another option is to use fourier terms

```{r}
trend_season_events_ar_tbl <- 
    trend_season_events_tbl %>% 
    tk_augment_lags(.value = appointments, .lags = 40)
```

```{r}
trend_season_events_ar_tbl %>%
    plot_time_series_regression(
        .date_var = appointment_date,
        .formula = appointments ~ splines::ns(index.num, df = 4) + 
            wday.lbl + month.lbl +
            bank_holiday + training + 
            appointments_lag40,
        .show_summary = TRUE
    )
```

```{r}
# add in lagged event terms
trend_season_events_lagged_ar_tbl <-
    trend_season_events_ar_tbl %>% 
    tk_augment_lags(.value = bank_holiday, .lags = 1) %>% 
    tk_augment_lags(.value = training, .lags = 1)

trend_season_events_lagged_ar_tbl %>% 
    plot_time_series_regression(
        .date_var = appointment_date,
        .formula = appointments ~ splines::ns(index.num, df = 4) + 
            wday.lbl + month.lbl +
            bank_holiday + training + 
            appointments_lag40 +
            bank_holiday_lag1 + training_lag1,
        .show_summary = TRUE
    )
```

```{r}
trend_season_events_lagged_ar_mdl <-
    lm(
        appointments ~ splines::ns(index.num, df = 4) + 
            wday.lbl + month.lbl +
            bank_holiday + training + 
            appointments_lag40 +
            bank_holiday_lag1 + training_lag1,
        trend_season_events_lagged_ar_tbl
    )

summary(trend_season_events_lagged_ar_mdl)

## Explore results
trend_season_events_lagged_ar_results <- 
    trend_season_events_lagged_ar_tbl %>% 
    drop_na() %>% 
    select(appointment_date, .observed = appointments, everything()) %>% 
    broom::augment(trend_season_events_lagged_ar_mdl, data = .) %>% 
    mutate(.resid = .observed - .fitted)


trend_season_events_lagged_ar_results %>% 
    select(.resid) %>% 
    ggplot(aes(.resid)) +
    geom_histogram(bins = 30, fill = "skyblue", color = "grey30") +
    theme_bw()

trend_season_events_lagged_ar_results %>% 
    select(.observed, .fitted) %>% 
    ggplot(aes(.observed, .fitted)) +
    geom_point(alpha = 0.5) +
    geom_abline() +
    theme_bw()

trend_season_events_lagged_ar_results %>%
    ggplot(aes(.fitted, .resid)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 0) +
    theme_bw()

trend_season_events_lagged_ar_results %>% 
    plot_acf_diagnostics(.date_var = appointment_date, .value = .resid, .lags = 262)

anova(trend_season_events_lagged_ar_mdl)
```

Explore fourier terms for longer periods

```{r}
time_feats_events_lags_fourier_tbl <- 
    time_feats_events_lags_tbl %>% 
    tk_augment_fourier(.date_var = appointment_date, .periods = c(40))

time_feats_events_lags_fourier_tbl %>% glimpse()
```

```{r}
time_feats_events_lags_fourier_tbl %>% 
    plot_time_series_regression(
        .date_var = appointment_date,
        .formula = appointments ~ splines::ns(index.num, df = 4) + 
            wday.lbl + month.lbl +
            bank_holiday + training + 
            appointments_lag1 + appointments_lag2 + appointments_lag3 + appointments_lag4 +
            bank_holiday_lag1 + training_lag1 +
            appointment_date_sin40_K1 + appointment_date_cos40_K1,
        .show_summary = TRUE)
```

External Regressors and lagged external regressors

Workforce

Population

Other staff appointments

```{r}

workforce <- read_rds("00_data/processed/wakefield_workforce_monthly.rds")

workforce_ts <-
    tibble("extract_date" = tk_make_timeseries(
        start_date = min(workforce$extract_date),
        end_date = max(workforce$extract_date)
    )) %>%
    left_join(workforce) %>%
    fill(contains("total")) %>% 
    rename(appointment_date = extract_date)
```

```{r}
# add in external regressors
trend_season_events_lagged_ar_xregs_tbl <-
    trend_season_events_lagged_ar_tbl %>% 
    left_join(workforce_ts)

trend_season_events_lagged_ar_xregs_tbl %>% 
    plot_time_series_regression(
        .date_var = appointment_date,
        .formula = appointments ~ splines::ns(index.num, df = 4) + 
            wday.lbl + month.lbl +
            bank_holiday + training + 
            bank_holiday_lag1 + training_lag1 +
            total_dpc,
        .show_summary = TRUE
    )
```
